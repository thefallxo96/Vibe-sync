<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>VibeSync</title>
    <style>
      :root {
        --bg1: #111827;
        --bg2: #0b0f1a;
        --panel: #151a2a;
        --panel-2: #101626;
        --text: #e7e9f3;
        --muted: #9aa4b2;
        --accent: #38bdf8;
        --glow: rgba(56, 189, 248, 0.35);
        --pulse-speed: 2.2s;
      }
      * { box-sizing: border-box; }
      body {
        font-family: "Space Grotesk", system-ui, -apple-system, sans-serif;
        margin: 0;
        background: radial-gradient(circle at top, var(--bg1), var(--bg2));
        color: var(--text);
        padding: 40px;
        position: relative;
        overflow-x: hidden;
        transition: background 0.6s ease;
      }
      .glow {
        position: fixed;
        width: 640px;
        height: 640px;
        top: -200px;
        right: -220px;
        background: radial-gradient(circle, var(--glow), transparent 70%);
        filter: blur(10px);
        opacity: 0.9;
        animation: float 8s ease-in-out infinite, moodPulse var(--pulse-speed) ease-in-out infinite;
        pointer-events: none;
        z-index: 0;
      }
      @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(25px); }
        100% { transform: translateY(0px); }
      }
      @keyframes moodPulse {
        0% { opacity: 0.55; transform: scale(0.98); }
        50% { opacity: 1; transform: scale(1.02); }
        100% { opacity: 0.55; transform: scale(0.98); }
      }

      .container { max-width: 1040px; margin: 0 auto; position: relative; z-index: 1; }
      .header { display: flex; justify-content: space-between; align-items: baseline; gap: 16px; }
      .header h1 { margin: 0; font-size: 28px; letter-spacing: 0.3px; }
      .header p { margin: 6px 0 0; }

      .grid { display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 20px; margin-top: 20px; }
      .stack { display: grid; gap: 20px; }
      .card {
        background: var(--panel);
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      }

      button {
        margin-right: 6px;
        padding: 8px 11px;
        border-radius: 8px;
        border: none;
        background: var(--accent);
        color: #001018;
        font-weight: 600;
        font-size: 13px;
        cursor: pointer;
      }
      button.secondary { background: #2b3348; color: var(--text); }

      select, input[type="text"] {
        background: #101522;
        color: var(--text);
        border: 1px solid #2b3348;
        border-radius: 8px;
        padding: 8px 10px;
        margin-right: 8px;
      }

      input[type="range"] { vertical-align: middle; width: 160px; }
      .row { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
      .muted { color: var(--muted); font-size: 14px; }
      .pill {
        background: #22304f;
        color: #9ad7ff;
        padding: 6px 12px;
        border-radius: 999px;
        font-weight: 600;
        display: inline-block;
      }
      .track { display: flex; gap: 16px; align-items: center; margin-top: 12px; }
      .art { width: 120px; height: 120px; border-radius: 12px; object-fit: cover; background: #0d1222; }
      pre { background: #0d1222; color: #cbd5e1; padding: 12px; border-radius: 10px; overflow-x: auto; }
      #progress-bar { box-shadow: 0 0 12px var(--glow), 0 0 24px var(--glow); }

      .mood-entry {
        display:flex; gap:10px; align-items:center;
        background: var(--panel-2);
        padding:8px 10px; border-radius:10px;
      }
      .mood-entry img {
        width:48px;height:48px;border-radius:8px;object-fit:cover;background:#111;
      }
      .section-title { margin: 0 0 10px; font-size: 16px; color: #cbd5e1; }
      .mini { font-size: 12px; color: var(--muted); }

      #mood-board {
        max-height: 420px;
        overflow-y: auto;
        padding-right: 6px;
      }

      .collapse-btn {
        background: #1c2740;
        color: #cbd5e1;
        border: 1px solid #2b3348;
        font-size: 12px;
        padding: 6px 8px;
        border-radius: 8px;
        margin-right: 6px;
      }
    </style>
  </head>
  <body>
    <div class="glow" id="glow"></div>

    <div class="container">
      <div class="header">
        <div>
          <h1>VibeSync</h1>
          <p class="muted">Mood‑mapping your Spotify in real time.</p>
        </div>
      </div>

      {% if authed %}
      <div class="grid">
        <div class="card">
          <div class="row" style="margin-bottom: 12px;">
            <button onclick="play()">Play</button>
            <button onclick="pause()" class="secondary">Pause</button>
            <button onclick="previous()" class="secondary">Prev</button>
            <button onclick="nextTrack()" class="secondary">Next</button>
            <input type="range" min="0" max="100" value="50" oninput="setVolume(this.value)" />
            <input id="queueInput" type="text" placeholder="Paste Spotify track URL" style="width: 240px;" />
            <button onclick="queueTrack()" class="secondary">Queue</button>
            <button onclick="checkVibe()" class="secondary">Vibe Check</button>
            <button onclick="queueNowAndPlay()" class="secondary">Play Rec Now</button>
            <button onclick="nextRecommendation()" class="secondary">Next Rec</button>
            <a href="/spotify/logout/"><button class="secondary">Logout</button></a>
          </div>

          <div id="status" class="muted">Click “Vibe Check” to load current track + mood.</div>
          <div class="muted" style="margin-top:6px;">
            Mode: <span class="pill">Vibe‑Only Recommendations</span>
          </div>
          <div id="track" class="track"></div>

          <div id="progress-wrap" style="margin-top: 12px;">
            <div style="height: 6px; background:#0d1222; border-radius: 999px; overflow:hidden;">
              <div id="progress-bar" style="height: 6px; width: 0%; background: #38bdf8;"></div>
            </div>
            <div class="muted" style="margin-top:6px;">
              <span id="time-elapsed">0:00</span> / <span id="time-total">0:00</span>
            </div>
          </div>

          <div class="row" style="margin-top: 14px;">
            <span class="muted">Add to mood:</span>
            <select id="moodSelect">
              <option>Hype</option>
              <option>Chill</option>
              <option>Sad</option>
              <option>Romantic</option>
              <option>Menacing</option>
              <option>Neutral</option>
            </select>
            <span class="muted">Intensity:</span>
            <input id="moodIntensity" type="range" min="0" max="100" value="50" />
            <span id="moodIntensityLabel" class="muted">50</span>
            <button onclick="addMood('app')">App</button>
            <button onclick="addMood('spotify')" class="secondary">Spotify</button>
            <button onclick="addMood('both')" class="secondary">Both</button>
          </div>
        </div>

        <div class="stack">
          <div class="card">
            <div class="section-title">Up Next</div>
            <div id="up-next"></div>
          </div>

          <div class="card">
            <div class="section-title">Mood Board</div>
            <div class="row" style="margin-bottom:10px;">
              <input id="searchInput" type="text" placeholder="Search songs…" oninput="renderMoodBoard()" />
              <select id="sortSelect" onchange="renderMoodBoard()">
                <option value="newest">Newest</option>
                <option value="oldest">Oldest</option>
                <option value="az">A → Z</option>
                <option value="za">Z → A</option>
              </select>
              <select id="viewSelect" onchange="renderMoodBoard()">
                <option value="moods">Moods First</option>
                <option value="songs">Songs First</option>
              </select>
            </div>
            <div id="mood-board"></div>
          </div>

          <div class="card">
            <div class="section-title">History (Last 20)</div>
            <div id="history"></div>
          </div>
        </div>
      </div>

      <div class="grid" style="grid-template-columns: 1fr 1fr; margin-top:20px;">
        <div class="card">
          <div class="section-title">Analytics</div>
          <canvas id="moodChart" height="180"></canvas>
          <div id="topArtists" class="mini" style="margin-top:8px;"></div>
        </div>

        <div class="card">
          <div class="section-title">Goal Mood</div>
          <div class="row">
            <select id="goalSelect">
              <option>Hype</option>
              <option>Chill</option>
              <option>Sad</option>
              <option>Romantic</option>
              <option>Menacing</option>
              <option>Neutral</option>
            </select>
            <button onclick="loadGoal()">Recommend</button>
          </div>
          <div id="goal-results" style="margin-top:10px;"></div>
        </div>
      </div>

      <details style="margin-top: 14px;">
        <summary class="muted">Debug JSON</summary>
        <pre id="out"></pre>
      </details>
      {% else %}
        <div class="card">
          <p>Not connected yet.</p>
          <a href="/spotify/login/"><button>Connect Spotify</button></a>
        </div>
      {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
      let deviceId = null;
      let vibeTimer = null;
      let lastProgress = 0;
      let lastDuration = 0;
      let lastTick = 0;
      let moodBoardData = [];
      let moodChart = null;
      let lastQueuedFor = null;
      let activeMoodPlayback = null;

      let recMode = false;
      let recList = [];
      let recIndex = 0;
      let lastTrackId = null;
      let lastRecFetchAt = 0;
      let queuedUris = new Set();
      let recInFlight = false;
      let queueInFlight = false;

      const REC_MIN_INTERVAL_MS = 6000;
      const REC_QUEUE_MIN = 4;
      const REC_QUEUE_ADD = 6;
      const REC_BUFFER_LOOKAHEAD = 8;

      const collapsedMoods = new Set();

      const intensityEl = document.getElementById("moodIntensity");
      const intensityLabel = document.getElementById("moodIntensityLabel");
      if (intensityEl) {
        intensityEl.addEventListener("input", () => {
          intensityLabel.textContent = intensityEl.value;
        });
      }

      window.onSpotifyWebPlaybackSDKReady = () => { initWebPlayback(); };

      async function initWebPlayback() {
        const tokenRes = await fetch("/spotify/api/token/");
        const tokenData = await tokenRes.json();
        if (!tokenData.authenticated) return;

        const token = tokenData.access_token;

        const player = new Spotify.Player({
          name: "VibeSync Web Player",
          getOAuthToken: cb => cb(token),
          volume: 0.5
        });

        player.addListener("ready", async ({ device_id }) => {
          deviceId = device_id;
          await fetch(`/spotify/api/transfer/?device_id=${deviceId}`);
        });

        player.connect();
      }

      function fmt(ms) {
        if (!ms && ms !== 0) return "0:00";
        const total = Math.floor(ms / 1000);
        const m = Math.floor(total / 60);
        const s = String(total % 60).padStart(2, "0");
        return `${m}:${s}`;
      }

      function updateProgress(progress, duration) {
        const bar = document.getElementById("progress-bar");
        const elapsed = document.getElementById("time-elapsed");
        const total = document.getElementById("time-total");
        if (!duration) {
          bar.style.width = "0%";
          elapsed.textContent = "0:00";
          total.textContent = "0:00";
          return;
        }
        const pct = Math.min(100, Math.max(0, (progress / duration) * 100));
        bar.style.width = `${pct}%`;
        elapsed.textContent = fmt(progress);
        total.textContent = fmt(duration);
      }

      function animateProgress() {
        if (!lastDuration) return;
        const now = Date.now();
        const elapsed = now - lastTick;
        const progress = Math.min(lastDuration, lastProgress + elapsed);
        updateProgress(progress, lastDuration);
        requestAnimationFrame(animateProgress);
      }

      function setGlow(mood) {
        const map = {
          hype: { glow: "rgba(255, 87, 51, 0.5)", bg1:"#301018", bg2:"#0b0f1a", pulse:"1.2s" },
          menacing: { glow: "rgba(180, 0, 0, 0.5)", bg1:"#2a0505", bg2:"#0b0f1a", pulse:"1.4s" },
          sad: { glow: "rgba(59, 130, 246, 0.45)", bg1:"#0f1d38", bg2:"#0b0f1a", pulse:"2.6s" },
          chill: { glow: "rgba(16, 185, 129, 0.45)", bg1:"#0c1f1a", bg2:"#0b0f1a", pulse:"3s" },
          romantic: { glow: "rgba(236, 72, 153, 0.45)", bg1:"#2a1020", bg2:"#0b0f1a", pulse:"2.2s" },
          neutral: { glow: "rgba(56, 189, 248, 0.35)", bg1:"#182034", bg2:"#0b0f1a", pulse:"2.2s" },
          unknown: { glow: "rgba(56, 189, 248, 0.35)", bg1:"#182034", bg2:"#0b0f1a", pulse:"2.2s" },
        };
        const key = mood.toLowerCase();
        const cfg = map[key] || map.neutral;
        document.documentElement.style.setProperty("--glow", cfg.glow);
        document.documentElement.style.setProperty("--bg1", cfg.bg1);
        document.documentElement.style.setProperty("--bg2", cfg.bg2);
        document.documentElement.style.setProperty("--pulse-speed", cfg.pulse);
        document.getElementById("glow").style.background =
          `radial-gradient(circle, ${cfg.glow}, transparent 70%)`;
      }

      function renderUpNext() {
        const up = document.getElementById("up-next");
        if (!recList.length) {
          up.innerHTML = `<p class="muted">No recommendations yet.</p>`;
          return;
        }
        const slice = recList.slice(recIndex + 1, recIndex + 6);
        if (!slice.length) {
          up.innerHTML = `<p class="muted">No upcoming tracks.</p>`;
          return;
        }
        up.innerHTML = slice.map(t => `
          <div class="mood-entry" style="margin-bottom:8px;">
            <img src="${t.image || ""}" alt="">
            <div>
              <div style="font-size:13px;font-weight:600;">${t.name}</div>
              <div class="muted" style="font-size:12px;">${(t.artists || []).join(", ")}</div>
              <button class="secondary" style="margin-top:6px;" onclick="playUri('${t.spotify_url || ""}')">Play</button>
            </div>
          </div>
        `).join("");
      }

      async function refreshRecommendations(force = false) {
        const now = Date.now();
        if (recInFlight) return false;
        if (!force && now - lastRecFetchAt < REC_MIN_INTERVAL_MS) return true;
        recInFlight = true;
        lastRecFetchAt = now;

        const mood = document.getElementById("moodSelect").value;
        const intensity = document.getElementById("moodIntensity")?.value || 50;
        const current = lastTrackId || "";

        const res = await fetch(`/spotify/api/recommend/?mood=${encodeURIComponent(mood)}&intensity=${intensity}&limit=30&current_track=${current}`);
        const data = await res.json();
        recInFlight = false;
        if (!data.ok || !data.tracks?.length) return false;

        recList = data.tracks;
        recIndex = 0;
        renderUpNext();
        return true;
      }

      async function queueRecBuffer() {
        if (!deviceId || !recList.length) return;
        if (queueInFlight) return;

        queueInFlight = true;

        const remaining = recList.length - (recIndex + 1);
        if (remaining < REC_QUEUE_MIN) {
          await refreshRecommendations(true);
        }

        const toQueue = recList.slice(recIndex + 1, recIndex + 1 + REC_QUEUE_ADD + REC_BUFFER_LOOKAHEAD);
        for (const t of toQueue) {
          if (!t?.uri) continue;
          if (queuedUris.has(t.uri)) continue;
          queuedUris.add(t.uri);
          await fetch(`/spotify/api/queue/?uri=${encodeURIComponent(t.uri)}&device_id=${deviceId || ""}`);
        }

        renderUpNext();
        queueInFlight = false;
      }

      function maybeAutoQueue(track, mood) {
        if (!track || !track.id || !track.duration_ms) return;
        if (lastQueuedFor === track.id) return;

        const remaining = (track.duration_ms || 0) - (track.progress_ms || 0);
        if (remaining > 0 && remaining < 4000) {
          lastQueuedFor = track.id;
          queueRecBuffer();
        }
      }

      async function checkVibe() {
        const res = await fetch("/spotify/api/vibe/");
        const data = await res.json();
        document.getElementById("out").textContent = JSON.stringify(data, null, 2);

        if (!data.playing) {
          document.getElementById("status").textContent = data.message || "Nothing playing.";
          document.getElementById("track").innerHTML = "";
          updateProgress(0, 0);
          lastDuration = 0;
          setGlow("neutral");
          return;
        }

        const track = data.track || {};
        const mood = data.mood || "unknown";
        const selectedMood = document.getElementById("moodSelect").value;
        const finalMood = (mood === "unknown") ? selectedMood : mood;

        document.getElementById("status").innerHTML =
          `<span class="pill">${finalMood.toUpperCase()}</span>`;

        document.getElementById("track").innerHTML = `
          <img class="art" src="${track.image || ""}" alt="album art" />
          <div>
            <div style="font-size: 18px; font-weight: 600;">${track.name || "Unknown Track"}</div>
            <div class="muted">${(track.artists || []).join(", ")} — ${track.album || ""}</div>
            ${track.spotify_url ? `<a class="muted" href="${track.spotify_url}" target="_blank">Open in Spotify</a>` : ""}
          </div>
        `;

        setGlow(finalMood);

        lastProgress = track.progress_ms || 0;
        lastDuration = track.duration_ms || 0;
        lastTick = Date.now();
        updateProgress(lastProgress, lastDuration);

        if (track.id && track.id !== lastTrackId) {
          lastTrackId = track.id;
          const idx = recList.findIndex(r => r.id === track.id);
          if (idx >= 0) recIndex = idx;
          if (!recMode) {
            refreshRecommendations(false);
          }
        }

        maybeAutoQueue(track, activeMoodPlayback || finalMood);
      }

      async function play() { await fetch(`/spotify/api/play/?device_id=${deviceId || ""}`); }
      async function pause() { await fetch(`/spotify/api/pause/?device_id=${deviceId || ""}`); }
      async function previous() { await fetch(`/spotify/api/previous/?device_id=${deviceId || ""}`); }
      async function nextTrack() { await fetch(`/spotify/api/next/?device_id=${deviceId || ""}`); }
      async function setVolume(v) { await fetch(`/spotify/api/volume/?v=${v}&device_id=${deviceId || ""}`); }

      async function queueTrack() {
        const input = document.getElementById("queueInput").value.trim();
        if (!input) return;
        let uri = input;
        if (input.includes("open.spotify.com/track/")) {
          const id = input.split("track/")[1].split("?")[0];
          uri = `spotify:track:${id}`;
        }
        await fetch(`/spotify/api/queue/?uri=${encodeURIComponent(uri)}&device_id=${deviceId || ""}`);
      }

      async function queueNowAndPlay() {
        if (!deviceId) return;
        const ok = await refreshRecommendations(true);
        if (!ok || !recList.length) return;

        recMode = true;
        recIndex = Math.floor(Math.random() * recList.length);
        const first = recList[recIndex];
        await fetch(`/spotify/api/play-uri/?uri=${encodeURIComponent(first.uri)}&device_id=${deviceId || ""}`);
        queuedUris.clear();
        await queueRecBuffer();
      }

      async function nextRecommendation() {
        if (!deviceId || !recList.length) return;

        recMode = true;
        recIndex = (recIndex + 1) % recList.length;
        const next = recList[recIndex];
        if (!next) return;

        await fetch(`/spotify/api/play-uri/?uri=${encodeURIComponent(next.uri)}&device_id=${deviceId || ""}`);
        await queueRecBuffer();
      }

      async function playUri(url, moodName = null) {
        if (!url) return;
        const uri = url.replace("https://open.spotify.com/track/", "spotify:track:");
        await fetch(`/spotify/api/play-uri/?uri=${encodeURIComponent(uri)}&device_id=${deviceId || ""}`);

        const idx = recList.findIndex(r => r.spotify_url === url);
        if (idx >= 0) recIndex = idx;

        renderUpNext();

        if (moodName) {
          document.getElementById("moodSelect").value = moodName;
          setGlow(moodName);
          activeMoodPlayback = moodName;
        }
      }

      async function playMoodPlaylist(moodName) {
        recMode = false;
        queuedUris.clear();

        const moodData = moodBoardData.find(m => m.name === moodName);
        if (!moodData || !moodData.entries.length) return;

        document.getElementById("moodSelect").value = moodName;
        setGlow(moodName);
        activeMoodPlayback = moodName;

        const first = moodData.entries[0];
        if (first.spotify_url) {
          await playUri(first.spotify_url, moodName);
        }

        for (const e of moodData.entries.slice(1)) {
          if (!e.spotify_url) continue;
          const uri = e.spotify_url.replace("https://open.spotify.com/track/", "spotify:track:");
          if (queuedUris.has(uri)) continue;
          queuedUris.add(uri);
          await fetch(`/spotify/api/queue/?uri=${encodeURIComponent(uri)}&device_id=${deviceId || ""}`);
        }

        await refreshRecommendations(true);
        await queueRecBuffer();
      }

      async function addMood(target) {
        const mood = document.getElementById("moodSelect").value;
        let url = "/spotify/api/mood/add-app/";
        if (target === "spotify") url = "/spotify/api/mood/add-spotify/";
        if (target === "both") url = "/spotify/api/mood/add-both/";
        const res = await fetch(`${url}?mood=${encodeURIComponent(mood)}`);
        const data = await res.json();
        document.getElementById("out").textContent = JSON.stringify(data, null, 2);
        loadMoodBoard();
        loadHistory();
        loadAnalytics();
      }

      async function removeFromApp(mood, trackId) {
        const res = await fetch(`/spotify/api/mood/remove-app/?mood=${encodeURIComponent(mood)}&track_id=${trackId}`);
        const data = await res.json();
        document.getElementById("out").textContent = JSON.stringify(data, null, 2);
        loadMoodBoard();
      }

      async function removeFromSpotify(mood, trackUrl) {
        const uri = trackUrl.replace("https://open.spotify.com/track/", "spotify:track:");
        const res = await fetch(`/spotify/api/mood/remove-spotify/?mood=${encodeURIComponent(mood)}&track_uri=${encodeURIComponent(uri)}`);
        const data = await res.json();
        document.getElementById("out").textContent = JSON.stringify(data, null, 2);
      }

      async function loadMoodBoard() {
        const res = await fetch("/spotify/api/mood/board/");
        const data = await res.json();
        moodBoardData = data.moods || [];
        renderMoodBoard();
      }

      function toggleMoodCollapse(name) {
        if (collapsedMoods.has(name)) collapsedMoods.delete(name);
        else collapsedMoods.add(name);
        renderMoodBoard();
      }

      function renderMoodBoard() {
        const board = document.getElementById("mood-board");
        const search = (document.getElementById("searchInput")?.value || "").toLowerCase();
        const sort = (document.getElementById("sortSelect")?.value || "newest");
        const view = (document.getElementById("viewSelect")?.value || "moods");

        let moods = JSON.parse(JSON.stringify(moodBoardData));
        if (search) {
          moods = moods.map(m => ({
            ...m,
            entries: m.entries.filter(e =>
              e.track_name.toLowerCase().includes(search) ||
              e.artists.toLowerCase().includes(search)
            )
          }));
        }

        if (sort === "az") moods.forEach(m => m.entries.sort((a,b) => a.track_name.localeCompare(b.track_name)));
        else if (sort === "za") moods.forEach(m => m.entries.sort((a,b) => b.track_name.localeCompare(a.track_name)));
        else if (sort === "oldest") moods.forEach(m => m.entries.reverse());

        if (view === "songs") {
          const flat = moods.flatMap(m => m.entries.map(e => ({...e, mood: m.name})));
          if (!flat.length) {
            board.innerHTML = `<p class="muted">No mood entries yet.</p>`;
            return;
          }
          board.innerHTML = flat.map(e => `
            <div class="mood-entry" style="margin-bottom:10px;">
              <img src="${e.image || ""}" alt="">
              <div>
                <div style="font-size:14px;font-weight:600;">${e.track_name}</div>
                <div class="muted" style="font-size:12px;">${e.artists}</div>
                <div class="muted" style="font-size:12px;">Mood: ${e.mood}</div>
                ${e.spotify_url ? `<a class="muted" style="font-size:12px;" href="${e.spotify_url}" target="_blank">Open</a>` : ""}
                <div style="margin-top:6px;">
                  <button class="secondary" onclick="playUri('${e.spotify_url || ""}', '${e.mood}')">Play</button>
                  <button class="secondary" onclick="removeFromApp('${e.mood}', '${e.track_id || ""}')">Remove (App)</button>
                  ${e.spotify_url ? `<button class="secondary" onclick="removeFromSpotify('${e.mood}', '${e.spotify_url}')">Remove (Spotify)</button>` : ""}
                </div>
              </div>
            </div>
          `).join("");
          return;
        }

        if (!moods.length) {
          board.innerHTML = `<p class="muted">No mood entries yet.</p>`;
          return;
        }

        board.innerHTML = moods.map(m => {
          const collapsed = collapsedMoods.has(m.name);
          const arrow = collapsed ? "▼" : "▲";
          return `
            <div style="margin-bottom:16px;">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                <div style="font-weight:600;">${m.name}</div>
                <div>
                  <button class="collapse-btn" onclick="toggleMoodCollapse('${m.name}')">${arrow}</button>
                  <button class="secondary" onclick="playMoodPlaylist('${m.name}')">Play Mood</button>
                </div>
              </div>
              ${collapsed ? "" : `
              <div style="display:flex; gap:12px; flex-wrap:wrap;">
                ${m.entries.length === 0 ? `<span class="muted">No songs yet.</span>` : m.entries.map(e => `
                  <div class="mood-entry">
                    <img src="${e.image || ""}" alt="">
                    <div>
                      <div style="font-size:14px;font-weight:600;">${e.track_name}</div>
                      <div class="muted" style="font-size:12px;">${e.artists}</div>
                      ${e.spotify_url ? `<a class="muted" style="font-size:12px;" href="${e.spotify_url}" target="_blank">Open</a>` : ""}
                      <div style="margin-top:6px;">
                        <button class="secondary" onclick="playUri('${e.spotify_url || ""}', '${m.name}')">Play</button>
                        <button class="secondary" onclick="removeFromApp('${m.name}', '${e.track_id || ""}')">Remove (App)</button>
                        ${e.spotify_url ? `<button class="secondary" onclick="removeFromSpotify('${m.name}', '${e.spotify_url}')">Remove (Spotify)</button>` : ""}
                      </div>
                    </div>
                  </div>
                `).join("")}
              </div>
              `}
            </div>
          `;
        }).join("");
      }

      async function loadHistory() {
        const res = await fetch("/spotify/api/history/");
        const data = await res.json();
        const history = document.getElementById("history");
        if (!data.history || data.history.length === 0) {
          history.innerHTML = `<p class="muted">No history yet.</p>`;
          return;
        }
        history.innerHTML = data.history.map(e => `
          <div class="mood-entry" style="margin-bottom:10px;">
            <img src="${e.image || ""}" alt="">
            <div>
              <div style="font-size:14px;font-weight:600;">${e.track_name}</div>
              <div class="muted" style="font-size:12px;">${e.artists}</div>
              ${e.spotify_url ? `<a class="muted" style="font-size:12px;" href="${e.spotify_url}" target="_blank">Open</a>` : ""}
            </div>
          </div>
        `).join("");
      }

      async function loadAnalytics() {
        const res = await fetch("/spotify/api/analytics/");
        const data = await res.json();
        const moods = data.moods || [];
        const artists = data.artists || [];
        const topArtists = document.getElementById("topArtists");

        if (!moods.length) {
          topArtists.textContent = "No data yet.";
          return;
        }

        const labels = moods.map(m => m.mood__name);
        const counts = moods.map(m => m.count);

        if (moodChart) moodChart.destroy();
        const ctx = document.getElementById("moodChart");
        moodChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels,
            datasets: [{ data: counts, backgroundColor: ["#38bdf8","#f97316","#22c55e","#e879f9","#f43f5e","#facc15"] }]
          },
          options: { plugins: { legend: { labels: { color: "#cbd5e1" } } } }
        });

        topArtists.textContent =
          artists.slice(0,5).map(a => `${a.artists} (${a.count})`).join(", ") || "No data yet.";
      }

      async function loadGoal() {
        const goal = document.getElementById("goalSelect").value;
        const res = await fetch(`/spotify/api/goal/?goal=${encodeURIComponent(goal)}`);
        const data = await res.json();
        const wrap = document.getElementById("goal-results");

        if (!data.tracks || data.tracks.length === 0) {
          wrap.innerHTML = `<p class="muted">No tracks saved for this mood yet.</p>`;
          return;
        }

        wrap.innerHTML = data.tracks.map(t => `
          <div class="mood-entry" style="margin-bottom:10px;">
            <img src="${t.image || ""}" alt="">
            <div>
              <div style="font-size:14px;font-weight:600;">${t.track_name}</div>
              <div class="muted" style="font-size:12px;">${t.artists}</div>
              ${t.spotify_url ? `<a class="muted" style="font-size:12px;" href="${t.spotify_url}" target="_blank">Open</a>` : ""}
            </div>
          </div>
        `).join("");
      }

      function startAutoRefresh() {
        if (vibeTimer) return;
        vibeTimer = setInterval(checkVibe, 1000);
        requestAnimationFrame(animateProgress);
      }

      checkVibe();
      loadMoodBoard();
      loadHistory();
      loadAnalytics();
      startAutoRefresh();
    </script>

    <script src="https://sdk.scdn.co/spotify-player.js"></script>
  </body>
</html>
